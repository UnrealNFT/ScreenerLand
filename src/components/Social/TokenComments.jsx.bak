import { useState, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { FaHeart, FaFire, FaRocket, FaPaperPlane, FaTrash, FaReply, FaChevronDown, FaChevronUp } from 'react-icons/fa'
import toast from 'react-hot-toast'

export default function TokenComments({ tokenHash, tokenName, walletAddress }) {
  const [comments, setComments] = useState([])
  const [newComment, setNewComment] = useState('')
  const [replyTo, setReplyTo] = useState(null)
  const [replyText, setReplyText] = useState('')
  const [loading, setLoading] = useState(false)
  const [isExpanded, setIsExpanded] = useState(false)
  
  // Mock data for demo
  useEffect(() => {
    // TODO: Load comments from backend/IPFS
    // Empty by default - users will add real comments
    setComments([])
  }, [tokenHash])
  
  // Post comment
  const handlePostComment = () => {
    if (!walletAddress) {
      toast.error('Please connect your wallet to comment')
      return
    }
    
    if (!newComment.trim()) {
      toast.error('Comment cannot be empty')
      return
    }
    
    const comment = {
      id: Date.now().toString(),
      wallet: walletAddress,
      walletShort: `${walletAddress.substring(0, 4)}...${walletAddress.substring(walletAddress.length - 4)}`,
      text: newComment,
      timestamp: new Date(),
      reactions: { fire: 0, rocket: 0, heart: 0 },
      userReaction: null,
      replies: []
    }
    
    setComments(prev => [comment, ...prev])
    setNewComment('')
    toast.success('Comment posted!')
  }
  
  // Post reply
  const handlePostReply = (commentId) => {
    if (!walletAddress) {
      toast.error('Please connect your wallet to reply')
      return
    }
    
    if (!replyText.trim()) {
      toast.error('Reply cannot be empty')
      return
    }
    
    setComments(prev => prev.map(c => 
      c.id === commentId ? {
        ...c,
        replies: [...c.replies, {
          id: `${commentId}-${Date.now()}`,
          wallet: walletAddress,
          walletShort: `${walletAddress.substring(0, 4)}...${walletAddress.substring(walletAddress.length - 4)}`,
          text: replyText,
          timestamp: new Date()
        }]
      } : c
    ))
    
    setReplyText('')
    setReplyTo(null)
    toast.success('Reply posted!')
  }
  
  // React to comment
  const handleReaction = (commentId, reaction) => {
    if (!walletAddress) {
      toast.error('Please connect your wallet to react')
      return
    }
    
    setComments(prev => prev.map(comment => {
      if (comment.id === commentId) {
        const currentReaction = comment.userReaction
        const newReactions = { ...comment.reactions }
        
        // Remove old reaction
        if (currentReaction) {
          newReactions[currentReaction]--
        }
        
        // Add new reaction or toggle off
        if (currentReaction === reaction) {
          return { ...comment, reactions: newReactions, userReaction: null }
        } else {
          newReactions[reaction]++
          return { ...comment, reactions: newReactions, userReaction: reaction }
        }
      }
      return comment
    }))
  }
  
  // Delete comment (only owner)
  const handleDelete = (commentId) => {
    setComments(prev => prev.filter(c => c.id !== commentId))
    toast.success('Comment deleted')
  }
  
  // Format timestamp
  const formatTime = (timestamp) => {
    const diff = Date.now() - timestamp.getTime()
    const minutes = Math.floor(diff / 60000)
    const hours = Math.floor(diff / 3600000)
    const days = Math.floor(diff / 86400000)
    
    if (minutes < 1) return 'Just now'
    if (minutes < 60) return `${minutes}m ago`
    if (hours < 24) return `${hours}h ago`
    return `${days}d ago`
  }

  return (
    <div className="space-y-4">
      
      {/* Toggle Button */}
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full glass rounded-xl p-4 flex items-center justify-between hover:bg-white/5 transition-all"
      >
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center">
            ðŸ’¬
          </div>
          <div className="text-left">
            <h3 className="text-white font-bold">Comments</h3>
            <p className="text-white/60 text-sm">{comments.length} comments</p>
          </div>
        </div>
        {isExpanded ? <FaChevronUp className="text-white/60" /> : <FaChevronDown className="text-white/60" />}
      </button>

      {/* Comments Section (Collapsible) */}
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
            className="space-y-4"
          >
            {/* Comment Input */}
            <div className="glass rounded-xl p-4">
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-sm font-bold">
                  {walletAddress ? walletAddress.substring(0, 2).toUpperCase() : '??'}
                </div>
                <div className="flex-1">
                  <textarea
                    value={newComment}
                    onChange={(e) => setNewComment(e.target.value)}
                    placeholder={walletAddress ? "Share your thoughts..." : `Connect wallet to join ${tokenName || 'the'} community`}
                    disabled={!walletAddress}
                    rows={3}
                    className="w-full px-4 py-3 bg-dark-hover rounded-xl text-white outline-none focus:ring-2 focus:ring-primary transition-all resize-none disabled:opacity-50"
                  />
                  {!walletAddress && (
                    <div className="mt-2 text-white/60 text-sm">
                      ðŸ’¬ <span className="font-semibold">Welcome to the {tokenName || 'token'} community!</span>
                    </div>
                  )}
                  <div className="flex justify-between items-center mt-2">
                    <span className="text-white/40 text-sm">{newComment.length}/500</span>
                    <button
                      onClick={handlePostComment}
                      disabled={!walletAddress || !newComment.trim()}
                      className="btn-primary px-6 py-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                    >
                      <FaPaperPlane />
                      <span>Post</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
                className="px-4 py-2 bg-gradient-to-r from-primary to-secondary rounded-lg font-semibold text-white hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
              >
                <FaPaperPlane />
                Post
              </button>
            </div>
          </div>
        </div>
              </div>
            </div>
            
            {/* Comments List */}
            <div className="space-y-3">
              {comments.length === 0 ? (
                <div className="glass rounded-xl p-8 text-center">
                  <p className="text-white/40">No comments yet. Be the first to comment!</p>
                </div>
              ) : (
                <AnimatePresence>
                  {comments.map(comment => (
                    <motion.div 
                      key={comment.id}
                      className="glass rounded-xl p-4"
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0, x: -20 }}
                    >
                      {/* Comment Header */}
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex items-center gap-3">
                          <div className="w-8 h-8 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-xs font-bold">
                            {comment.walletShort.substring(0, 2).toUpperCase()}
                          </div>
                          <div>
                            <p className="text-white font-semibold">{comment.walletShort}</p>
                            <p className="text-white/40 text-xs">{formatTime(comment.timestamp)}</p>
                          </div>
                        </div>
                        
                        {comment.wallet === walletAddress && (
                          <button
                            onClick={() => handleDelete(comment.id)}
                            className="text-white/40 hover:text-red-500 transition-colors"
                          >
                            <FaTrash />
                          </button>
                        )}
                      </div>
                      
                      {/* Comment Text */}
                      <p className="text-white/80 mb-3">{comment.text}</p>
                      
                      {/* Reactions */}
                      <div className="flex items-center gap-4">
                        <button
                          onClick={() => handleReaction(comment.id, 'fire')}
                          className={`flex items-center gap-1 px-3 py-1 rounded-lg transition-all ${
                            comment.userReaction === 'fire'
                              ? 'bg-orange-500/30 text-orange-400'
                              : 'bg-dark-hover text-white/60 hover:bg-dark-hover/80'
                          }`}
                        >
                          <FaFire />
                          <span className="text-sm font-semibold">{comment.reactions.fire}</span>
                        </button>
                        
                        <button
                          onClick={() => handleReaction(comment.id, 'rocket')}
                          className={`flex items-center gap-1 px-3 py-1 rounded-lg transition-all ${
                            comment.userReaction === 'rocket'
                              ? 'bg-blue-500/30 text-blue-400'
                              : 'bg-dark-hover text-white/60 hover:bg-dark-hover/80'
                          }`}
                        >
                          <FaRocket />
                          <span className="text-sm font-semibold">{comment.reactions.rocket}</span>
                        </button>
                        
                        <button
                          onClick={() => handleReaction(comment.id, 'heart')}
                          className={`flex items-center gap-1 px-3 py-1 rounded-lg transition-all ${
                            comment.userReaction === 'heart'
                              ? 'bg-pink-500/30 text-pink-400'
                              : 'bg-dark-hover text-white/60 hover:bg-dark-hover/80'
                          }`}
                        >
                          <FaHeart />
                          <span className="text-sm font-semibold">{comment.reactions.heart}</span>
                        </button>
                        
                        <button
                          onClick={() => setReplyTo(replyTo === comment.id ? null : comment.id)}
                          className="flex items-center gap-1 px-3 py-1 rounded-lg bg-dark-hover text-white/60 hover:bg-dark-hover/80 transition-all ml-auto"
                        >
                          <FaReply />
                          <span className="text-sm">Reply</span>
                        </button>
                      </div>
                      
                      {/* Reply Input */}
                      {replyTo === comment.id && (
                        <motion.div
                          initial={{ opacity: 0, height: 0 }}
                          animate={{ opacity: 1, height: 'auto' }}
                          exit={{ opacity: 0, height: 0 }}
                          className="mt-4 pl-8 border-l-2 border-primary/30"
                        >
                          <div className="flex gap-3">
                            <div className="w-8 h-8 rounded-full bg-gradient-to-br from-secondary to-primary flex items-center justify-center text-xs font-bold">
                              {walletAddress ? walletAddress.substring(0, 2).toUpperCase() : '??'}
                            </div>
                            <div className="flex-1">
                              <textarea
                                value={replyText}
                                onChange={(e) => setReplyText(e.target.value)}
                                placeholder="Write a reply..."
                                rows={2}
                                className="w-full px-3 py-2 bg-dark-hover rounded-lg text-white outline-none focus:ring-2 focus:ring-primary transition-all resize-none text-sm"
                              />
                              <div className="flex gap-2 mt-2">
                                <button
                                  onClick={() => handlePostReply(comment.id)}
                                  disabled={!replyText.trim()}
                                  className="btn-primary px-4 py-1 text-sm disabled:opacity-50"
                                >
                                  Reply
                                </button>
                                <button
                                  onClick={() => setReplyTo(null)}
                                  className="px-4 py-1 text-sm bg-white/5 rounded-lg text-white/60 hover:bg-white/10"
                                >
                                  Cancel
                                </button>
                              </div>
                            </div>
                          </div>
                        </motion.div>
                      )}
                      
                      {/* Replies */}
                      {comment.replies.length > 0 && (
                        <div className="mt-4 pl-8 space-y-3 border-l-2 border-white/10">
                          {comment.replies.map(reply => (
                            <div key={reply.id} className="glass-inner rounded-lg p-3">
                              <div className="flex items-center gap-2 mb-2">
                                <div className="w-6 h-6 rounded-full bg-gradient-to-br from-secondary to-primary flex items-center justify-center text-xs font-bold">
                                  {reply.walletShort.substring(0, 2).toUpperCase()}
                                </div>
                                <p className="text-white/80 text-sm font-semibold">{reply.walletShort}</p>
                                <p className="text-white/40 text-xs">{formatTime(reply.timestamp)}</p>
                              </div>
                              <p className="text-white/70 text-sm">{reply.text}</p>
                            </div>
                          ))}
                        </div>
                      )}
                    </motion.div>
                  ))}
                </AnimatePresence>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  )
}
